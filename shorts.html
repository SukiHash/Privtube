<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PrivTube - Shorts</title>
  <style>
    /* Styling with private colors */
    body {
      font-family: Arial, sans-serif;
      background-color: #1a1a1a; /* Dark background */
      color: #fff; /* White text */
      margin: 0;
      padding: 0;
      display: flex;
    }
    #sidebar {
      width: 200px;
      background-color: #333; /* Dark sidebar background */
      height: 100vh; /* Full height sidebar */
      padding-top: 20px;
      position: fixed;
      left: 0;
      overflow-y: auto; /* Allow scrolling if needed */
    }
    #sidebar a {
      display: block;
      padding: 10px 20px;
      color: #fff;
      text-decoration: none;
      font-size: 18px;
      transition: background-color 0.3s;
    }
    #sidebar a:hover {
      background-color: #555; /* Darker on hover */
    }
    #sidebar a.active {
      background-color: #FF0000; /* Red background for active link */
    }
    #main {
      margin-left: 200px; /* Adjust main content area */
      padding: 20px;
      width: 80%;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #shortsPlayer {
      width: 80%;
      max-width: 800px;
      height: 450px; /* Adjust height as needed */
      overflow: hidden;
      position: relative;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 8px;
    }
    #errorMessage {
      color: red;
      font-size: 18px;
      text-align: center;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar">
    <a href="index.html" id="homeLink">Home</a>
    <a href="shorts.html" class="active">Shorts</a>
    <a href="#" onclick="historyPage()">History</a>
  </div>

  <!-- Main content -->
  <div id="main">
    <!-- Shorts Player -->
    <div id="shortsPlayer">
      <iframe id="shortsIframe" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>
    </div>
    <div id="errorMessage">Error: Unable to load videos. You have exceeded your API quota.</div>
  </div>

  <script>
    let shorts = []; // Array to store Shorts video IDs
    let currentIndex = -1; // Index to track the currently playing Shorts video
    let isLoading = false; // Flag to prevent multiple simultaneous requests
    let retryCount = 0; // Counter for retries
    const maxRetries = 3; // Maximum retries for loading videos

    // Array of API keys
    const apiKeys = [
      'AIzaSyC7r_0nZUd5YpfwyDFcjrKRy1Fhw_bs4I4',
      'AIzaSyDiTSfV-iZWDrQdl4Mi6LIn3FeQ07Y1ZWE',
      'AIzaSyC7wuJ6pAufq1X-z2gt2-ttC-c2pSm-4MM'
    ];
    let currentKeyIndex = 0;

    function getApiKey() {
      return apiKeys[currentKeyIndex];
    }

    function switchApiKey() {
      currentKeyIndex = (currentKeyIndex + 1) % apiKeys.length;
    }

    function loadShorts() {
      fetchShortsIds()
        .then(data => {
          shorts = data.items.map(item => item.id.videoId);
          playRandomShort();
        })
        .catch(error => {
          console.error('Error fetching Shorts IDs:', error);
          if (error.message.includes('quotaExceeded')) {
            switchApiKey();
            if (currentKeyIndex === 0) {
              document.getElementById('errorMessage').style.display = 'block';
              return;
            }
            loadShorts();
          } else if (error.message.includes('403')) {
            alert('Hey, due to rate limits, YouTube has temporarily stopped our site. Please come back later.');
          }
        });

      // Listen for scroll events
      window.addEventListener('scroll', handleScroll);
    }

    function handleScroll() {
      if (!isLoading && (window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
        isLoading = true;
        playNextShort();
      }
    }

    function playRandomShort() {
      currentIndex = Math.floor(Math.random() * shorts.length);
      playShortAtIndex(currentIndex);
    }

    function playNextShort() {
      currentIndex++;
      if (currentIndex >= shorts.length) {
        currentIndex = 0; // Loop back to the first video if at the end
      }
      playShortAtIndex(currentIndex);
    }

    function playPreviousShort() {
      currentIndex--;
      if (currentIndex < 0) {
        currentIndex = shorts.length - 1; // Loop back to the last video if at the beginning
      }
      playShortAtIndex(currentIndex);
    }

    function playShortAtIndex(index) {
      var shortsIframe = document.getElementById('shortsIframe');
      shortsIframe.src = `https://www.youtube.com/embed/${shorts[index]}?autoplay=1`; // Add autoplay=1 to autoplay

      shortsIframe.onerror = function() {
        if (retryCount < maxRetries) {
          retryCount++;
          playShortAtIndex(index); // Retry loading the same video
        } else {
          retryCount = 0;
          playNextShort(); // Move to the next video after max retries
        }
      };

      isLoading = false; // Reset isLoading flag
    }

    // Function to fetch Shorts video IDs (with a default query)
    function fetchShortsIds() {
      const query = 'shorts'; // Default search query
      var url = `https://www.googleapis.com/youtube/v3/search?key=${getApiKey()}&type=video&part=snippet&q=${query}&maxResults=50`;

      return fetch(url)
        .then(response => {
          if (response.status === 403) {
            return response.json().then(error => {
              if (error.error.errors[0].reason === 'quotaExceeded') {
                throw new Error('quotaExceeded');
              } else {
                throw new Error('403');
              }
            });
          }
          return response.json();
        })
        .then(data => {
          if (data.items) {
            return data;
          } else {
            throw new Error('No Shorts found.');
          }
        });
    }

    // Listen for arrow key events
    document.addEventListener('keydown', function(event) {
      if (event.key === 'ArrowDown') {
        playNextShort();
      } else if (event.key === 'ArrowUp') {
        playPreviousShort();
      }
    });

    // Function to load Home page (replace with actual functionality)
    function loadHome() {
      alert('Load Home page functionality not implemented.');
    }

    // Function to handle History page (replace with actual functionality)
    function historyPage() {
      alert('History page functionality not implemented.');
    }

    // Load Shorts when the page initially loads
    loadShorts();
  </script>
</body>
</html>

